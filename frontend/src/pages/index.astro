---
import { marked } from 'marked';

const API_BASE_URL = import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:8000';

const method = Astro.request.method;

let activeTab: 'text' | 'url' = 'text';
let sourceText = '';
let url = '';
let sourceLanguage = '';
let targetLanguage = '';
let category = '';

let responseJson: any = null;
let error: string | null = null;

if (method === 'POST') {
  const formData = await Astro.request.formData();
  activeTab = (formData.get('activeTab') as any) || 'text';
  sourceText = String(formData.get('sourceText') || '');
  url = String(formData.get('url') || '');
  sourceLanguage = String(formData.get('sourceLanguage') || '');
  targetLanguage = String(formData.get('targetLanguage') || '');
  category = String(formData.get('category') || '');

  const payload: any = {
    source_language: sourceLanguage || undefined,
    target_language: targetLanguage || undefined,
    category: category || undefined,
    enable_post_edit: true
  };

  let endpoint = '';
  if (activeTab === 'text') {
    endpoint = '/translate/text';
    payload.text = sourceText;
  } else {
    endpoint = '/translate/url';
    payload.url = url;
  }

  try {
    const resp = await fetch(`${API_BASE_URL}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await resp.json();
    if (!resp.ok) {
      error = data?.detail ? String(data.detail) : `Request failed (${resp.status})`;
    } else {
      responseJson = data;
    }
  } catch (e: any) {
    error = e?.message || 'Unknown error';
  }
}

const markdownOutput = (() => {
  if (!responseJson) return '';
  if (activeTab === 'text') {
    return responseJson.post_edited_text || responseJson.translated_text || '';
  }
  return responseJson.post_edited_markdown || responseJson.translated_markdown || '';
})();

const htmlPreview = markdownOutput ? marked.parse(markdownOutput) : '';
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Azure AI Custom Translator Platform</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; }
      header { padding: 16px 20px; border-bottom: 1px solid rgba(127,127,127,.3); }
      main { padding: 20px; max-width: 1100px; margin: 0 auto; }
      .tabs { display: flex; gap: 8px; margin-bottom: 14px; }
      .tab { padding: 8px 12px; border: 1px solid rgba(127,127,127,.35); border-radius: 8px; background: transparent; cursor: pointer; }
      .tab.active { background: rgba(127,127,127,.15); }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      label { display: block; font-size: 12px; opacity: .85; margin-bottom: 6px; }
      input, textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(127,127,127,.35); background: transparent; }
      textarea { min-height: 180px; resize: vertical; }
      .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
      .btn { margin-top: 12px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(127,127,127,.35); background: rgba(127,127,127,.15); cursor: pointer; }
      .panel { border: 1px solid rgba(127,127,127,.35); border-radius: 12px; padding: 12px; }
      pre { overflow: auto; padding: 12px; border-radius: 10px; background: rgba(127,127,127,.10); }
      .error { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,0,0,.35); background: rgba(255,0,0,.08); margin-bottom: 12px; }
      .muted { opacity: .7; font-size: 12px; }
      .preview :global(h1) { font-size: 22px; }
      .preview :global(h2) { font-size: 18px; }
      .preview :global(p) { line-height: 1.5; }
      .preview :global(code) { background: rgba(127,127,127,.18); padding: 2px 6px; border-radius: 6px; }
      .preview :global(pre code) { background: transparent; padding: 0; }
      @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } .row { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <header>
      <strong>Azure AI Custom Translator Platform</strong>
      <div class="muted">Text / URL translation with Azure Translator + optional OpenAI post-edit</div>
    </header>

    <main>
      {error && <div class="error">{error}</div>}

      <form method="post">
        <input type="hidden" name="activeTab" value={activeTab} />

        <div class="tabs">
          <button type="submit" class={`tab ${activeTab === 'text' ? 'active' : ''}`} name="activeTab" value="text">Text</button>
          <button type="submit" class={`tab ${activeTab === 'url' ? 'active' : ''}`} name="activeTab" value="url">URL</button>
        </div>

        <div class="row">
          <div>
            <label for="sourceLanguage">Source language</label>
            <input id="sourceLanguage" name="sourceLanguage" placeholder="en" value={sourceLanguage} />
          </div>
          <div>
            <label for="targetLanguage">Target language</label>
            <input id="targetLanguage" name="targetLanguage" placeholder="pt-br" value={targetLanguage} />
          </div>
          <div>
            <label for="category">Category (optional)</label>
            <input id="category" name="category" placeholder="custom category id" value={category} />
          </div>
        </div>

        <div class="grid" style="margin-top: 12px;">
          <div class="panel">
            {activeTab === 'text' ? (
              <>
                <label for="sourceText">Text</label>
                <textarea id="sourceText" name="sourceText" placeholder="Paste text to translate...">{sourceText}</textarea>
              </>
            ) : (
              <>
                <label for="url">URL</label>
                <input id="url" name="url" placeholder="https://example.com/article" value={url} />
                <div class="muted" style="margin-top: 8px;">The backend will extract the main article content and translate it to Markdown.</div>
              </>
            )}

            <button class="btn" type="submit">Translate</button>
          </div>

          <div class="panel preview">
            <div class="muted">Markdown preview</div>
            {markdownOutput ? (
              <div set:html={htmlPreview} />
            ) : (
              <div class="muted" style="margin-top: 8px;">No output yet.</div>
            )}

            {responseJson && (
              <>
                <div class="muted" style="margin-top: 14px;">Raw JSON</div>
                <pre>{JSON.stringify(responseJson, null, 2)}</pre>
              </>
            )}
          </div>
        </div>
      </form>
    </main>
  </body>
</html>
